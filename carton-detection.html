<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>纸箱检测 - LandingAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Viewer.js 图像查看器库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        accent: '#ff6b6b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <header class="fixed top-0 w-full bg-white/95 backdrop-blur-sm shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex justify-between items-center py-4">
                <div class="text-2xl font-bold text-primary">ABB</div>
                <ul class="flex space-x-8">
                    <li><a href="index.html" class="text-gray-700 font-medium hover:text-primary transition-colors">主页</a></li>
                    <li><a href="carton-detection.html" class="text-primary font-semibold">纸箱检测</a></li>
                    <li><a href="container-detection.html" class="text-gray-700 font-medium hover:text-primary transition-colors">周转箱检测</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="bg-gradient-to-br from-accent to-orange-500 text-white pt-32 pb-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">纸箱智能检测</h1>
            <p class="text-xl md:text-2xl opacity-90">上传纸箱图像，AI将自动检测检测纸箱的位置，并且使用矩形框标注出来</p>
        </div>
    </section>

    <section class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-8">上传纸箱图像</h2>
            
            <div id="uploadArea" class="border-3 border-dashed border-gray-300 rounded-xl p-12 text-center mb-8 cursor-pointer transition-all duration-300 hover:border-primary hover:bg-blue-50">
                <div class="text-6xl mb-4 text-primary">📦</div>
                <h3 class="text-xl font-semibold mb-2">拖放图像文件或点击上传</h3>
                <p class="text-gray-600 mb-4">支持 JPG、PNG 格式，最大文件大小 10MB</p>
                <input type="file" id="fileInput" accept="image/*" class="hidden" aria-label="选择纸箱图像文件">
                <button class="bg-primary text-white px-8 py-3 rounded-full font-semibold" onclick="document.getElementById('fileInput').click()">
                    选择文件
                </button>
            </div>
            
            <div id="imagePreview" class="text-center hidden">
                <h3 class="text-2xl font-semibold mb-4">预览图像</h3>
                <div class="relative mb-6 mx-auto max-w-4xl">
                   <div id="imageContainer" class="relative overflow-hidden cursor-move bg-gray-200 h-[600px] min-h-[600px]">
                            <img id="previewImage" class="absolute top-0 left-0 w-full h-full object-contain transition-transform duration-300" alt="预览图像">
                            <div id="loadingOverlay" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-2"></div>
                                    <p class="text-gray-600">加载中...</p>
                                </div>
                            </div>
                        </div>
                    <div class="mt-4 text-sm text-gray-600">
                        <p>💡 提示：使用鼠标滚轮缩放，拖拽图像平移，点击图像放大显示，屏幕右上退出全屏</p>
                    </div>
                </div>
                <div class="space-x-4">
                    <button class="bg-primary text-white px-8 py-3 rounded-full" onclick="startDetection()">开始检测</button>
                    <button class="bg-gray-600 text-white px-8 py-3 rounded-full" onclick="resetUpload()">重新选择</button>
                    <button class="bg-primary text-white px-8 py-3 rounded-full" onclick="saveToTrainingSet()">保存到训练集</button>
                </div>
            </div>
        </div>
    </section>

    <!-- 检测结果区域 -->
    <section id="resultsSection" class="py-20 bg-gray-50 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-8">检测结果</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-primary">检测统计</h3>
                    <div id="detectionStats" class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">检测到的纸箱数量:</span>
                            <span id="boxCount" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">平均置信度:</span>
                            <span id="avgConfidence" class="font-semibold">0%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">检测时间:</span>
                            <span id="detectionTime" class="font-semibold">-</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-primary">检测详情</h3>
                    <div id="detectionDetails" class="space-y-2">
                        <p class="text-gray-600">检测结果已标注在图像上，红色框表示检测到的纸箱位置。</p>
                        <p class="text-sm text-gray-500">每个检测框上方显示标签和置信度百分比。</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const resultsSection = document.getElementById('resultsSection');
        const imageContainer = document.getElementById('imageContainer');
        const zoomControls = document.getElementById('zoomControls');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Viewer.js 实例
        let viewer = null;
        let sourceImage=null;
        // 文件上传处理
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    loadingOverlay.classList.remove('hidden');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        sourceImage=e.target.result;
                        previewImage.onload = function() {
                            console.log('图像加载成功，尺寸:', previewImage.naturalWidth, 'x', previewImage.naturalHeight);
                            
                            // 初始化Viewer.js
                            if (viewer) {
                                viewer.destroy();
                            }
                            viewer = new Viewer(previewImage, {
                                inline: false,
                                toolbar: false,
                                navbar: false,
                                title: false,
                                rotatable: false,
                                scalable: false,
                                transition: false,
                                fullscreen: false,
                                keyboard: false,
                                zoomable: true,
                                movable: true,
                                zoomOnWheel: true,
                                zoomOnTouch: true,
                                minZoomRatio: 0.1,
                                maxZoomRatio: 20
                            });
                            
                            imagePreview.classList.remove('hidden');
                            uploadArea.classList.add('hidden');
                            loadingOverlay.classList.add('hidden');
                            
                            // 确保图像容器可见
                            imageContainer.style.display = 'block';
                        };
                        previewImage.onerror = function() {
                            console.error('图像加载失败');
                            loadingOverlay.classList.add('hidden');
                            alert('图像加载失败，请重新选择文件');
                        };
                    };
                    reader.onerror = function() {
                        console.error('文件读取失败');
                        loadingOverlay.classList.add('hidden');
                        alert('文件读取失败，请重新选择文件');
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('请选择图像文件（JPG、PNG格式）');
                }
            }
        });


        // 开始检测
        async function  startDetection() {
            const file =fileInput.files[0];
            if (!file) {
                alert('请先上传图像文件');
                return;
            }
            
            loadingOverlay.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('https://14.103.249.56:443/box_inference', {
                   method:"POST",
                   body:formData 
                });
                
                if (!response.ok) {
                    throw new Error(`纸箱检测失败: ${response.status}`);
                }
                const result = await response.json();

                // 在图像上绘制检测结果
                drawDetectionResults(result.predictions);
                
                resultsSection.classList.remove('hidden');
            } catch (error) {
                console.error('检测过程中出错:', error);
                alert('检测失败: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // 在图像上绘制检测结果
        function drawDetectionResults(result) {
            // 创建Canvas元素用于绘制
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置Canvas尺寸与原始图像相同
            canvas.width = previewImage.naturalWidth;
            canvas.height = previewImage.naturalHeight;
            
            // 在Canvas上绘制原始图像
            ctx.drawImage(previewImage, 0, 0, canvas.width, canvas.height);
            
            // 设置绘制样式
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#ff6b6b';
            ctx.fillStyle = 'rgba(255, 107, 107, 0.2)';
            ctx.font = '16px Arial';
            ctx.textBaseline = 'top';
            
            // 初始化统计变量
            let boxCount = 0;
            let totalConfidence = 0;
            
            // 假设result包含检测框信息
            if (result) {
                boxCount = result.length;
                
                result.forEach(rsl => {
                    // 解析边界框坐标（假设格式为[x1, y1, x2, y2]）
                    const [x1, y1, x2, y2] = rsl.bbox;
                    
                    // 绘制边界框
                    ctx.beginPath();
                    ctx.rect(x1, y1, x2 - x1, y2 - y1);
                    ctx.stroke();
                    ctx.fill();
                    
                    // 绘制标签和置信度
                    const label = rsl.label;
                    totalConfidence += rsl.score;;
                    
                    // 绘制标签背景
                    ctx.fillStyle = 'rgba(255, 107, 107, 0.8)';
                    const text = `${label} ${(rsl.score * 100).toFixed(1)}%`;
                    const textWidth = ctx.measureText(text).width;
                    
                    ctx.fillRect(x1, y1 - 25, textWidth + 10, 20);
                    
                    // 绘制标签文字
                    ctx.fillStyle = 'white';
                    ctx.fillText(text, x1 + 5, y1 - 22);
                    
                    // 重置填充颜色
                    ctx.fillStyle = 'rgba(255, 107, 107, 0.2)';
                });
            }
            
            // 更新检测统计信息
            updateDetectionStats(boxCount, totalConfidence, result);
            
            // 将Canvas内容转换为DataURL并设置为previewImage的src
            previewImage.src = canvas.toDataURL('image/png');
            
            // 重新初始化Viewer.js以支持新的图像
            if (viewer) {
                viewer.destroy();
            }
            viewer = new Viewer(previewImage, {
                inline: false,
                toolbar: false,
                navbar: false,
                title: false,
                rotatable: false,
                scalable: false,
                transition: false,
                fullscreen: false,
                keyboard: false,
                zoomable: true,
                movable: true,
                zoomOnWheel: true,
                zoomOnTouch: true,
                minZoomRatio: 0.1,
                maxZoomRatio: 20
            });
        }
        
        // 更新检测统计信息
        function updateDetectionStats(boxCount, totalConfidence, result) {
            const boxCountElement = document.getElementById('boxCount');
            const avgConfidenceElement = document.getElementById('avgConfidence');
            const detectionTimeElement = document.getElementById('detectionTime');
            
            // 更新纸箱数量
            boxCountElement.textContent = boxCount;
            
            // 更新平均置信度
            const avgConfidence = boxCount > 0 ? (totalConfidence / boxCount) * 100 : 0;
            avgConfidenceElement.textContent = `${avgConfidence.toFixed(1)}%`;
            
            // 更新检测时间
            const currentTime = new Date().toLocaleTimeString('zh-CN');
            detectionTimeElement.textContent = currentTime;
        }
        
        // 重置上传
        function resetUpload() {
            fileInput.value = '';
            imagePreview.classList.add('hidden');
            uploadArea.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            zoomControls.classList.add('hidden');
            
            // 销毁Viewer.js实例
            if (viewer) {
                viewer.destroy();
                viewer = null;
            }
        }
        //保存图像到训练集
        function saveToTrainingSet(){
            if(!sourceImage){
                alert('没有可保存的图像');
                return;
            }
            
            // 创建下载链接
            const downloadLink = document.createElement('a');
            downloadLink.href = sourceImage;
            
            // 获取当前时间作为文件名
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadLink.download = `carton-detection-${timestamp}.png`;
            
            // 触发下载
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        // 页面加载时的动画效果
        document.addEventListener('DOMContentLoaded', function() {
            const resultCards = document.querySelectorAll('.bg-white');
            resultCards.forEach((card, index) => {
                card.classList.add('opacity-0', 'translate-y-4');
                
                setTimeout(() => {
                    card.classList.add('transition-all', 'duration-600', 'ease-out');
                    card.classList.remove('opacity-0', 'translate-y-4');
                }, index * 200);
            });
        });
    </script>
</body>
</html>